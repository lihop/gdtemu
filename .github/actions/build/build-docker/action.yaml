---
name: Build libgdtemu inside a Docker container
inputs:
  platform:
    required: true
  scons-args:
    default: ''
runs:
  using: composite
  steps:
    - name: Cache Docker layers
      uses: jpribyl/action-docker-layer-caching@v0.1.0
      continue-on-error: true
      with:
        key: docker-cache-${{ inputs.platform }}-${{ hashFiles('**/*.Dockerfile') }}
        restore-keys: | # No restore keys in order to avoid snowball effect.
    - name: Build libgdtemu
      working-directory: addons/gdtemu/native
      shell: bash
      run: |
        docker-compose build gdtemu-${{ inputs.platform }}
        docker-compose run \
          -v $SCONS_CACHE:/scons-cache \
          -e SCONS_CACHE=/scons-cache \
          gdtemu-${{ matrix.platform }} scons ${{ inputs.scons-args }} -j2
